<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local Astronaut Emotion Detection</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #0B1426 0%, #1E3A8A 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            color: #06B6D4;
            margin-bottom: 10px;
            text-shadow: 0 0 20px rgba(6, 182, 212, 0.5);
        }

        .status-bar {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
            padding: 15px;
            background: rgba(30, 58, 138, 0.3);
            border-radius: 10px;
            border: 1px solid #06B6D4;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #6B7280;
        }

        .status-dot.active {
            background: #10B981;
            animation: pulse 2s infinite;
        }

        .status-dot.error {
            background: #EF4444;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .panel {
            background: rgba(30, 58, 138, 0.2);
            border: 1px solid #06B6D4;
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
        }

        .panel h2 {
            color: #06B6D4;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .video-container {
            position: relative;
            width: 100%;
            height: 300px;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        #videoElement {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #overlayCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .placeholder {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(45deg, #0B1426 25%, transparent 25%, transparent 75%, #0B1426 75%), 
                        linear-gradient(45deg, #0B1426 25%, #1E3A8A 25%, #1E3A8A 75%, #0B1426 75%);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
        }

        .placeholder-content {
            text-align: center;
            color: #6B7280;
        }

        .placeholder-content h3 {
            font-size: 1.2rem;
            margin-bottom: 10px;
        }

        .btn {
            background: linear-gradient(135deg, #10B981 0%, #06B6D4 100%);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(16, 185, 129, 0.4);
        }

        .btn:disabled {
            background: #6B7280;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-record {
            background: linear-gradient(135deg, #8B5CF6 0%, #1E3A8A 100%);
            padding: 15px 30px;
            font-size: 1.1rem;
            width: 100%;
            margin-bottom: 15px;
        }

        .btn-record.recording {
            background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
        }

        .countdown {
            font-size: 3rem;
            font-weight: bold;
            color: #06B6D4;
            text-align: center;
            margin: 20px 0;
            text-shadow: 0 0 20px rgba(6, 182, 212, 0.5);
        }

        .emotion-bars {
            margin-top: 15px;
        }

        .emotion-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background: rgba(6, 182, 212, 0.1);
            border-radius: 8px;
            border-left: 3px solid #06B6D4;
        }

        .emotion-name {
            font-weight: 600;
            text-transform: capitalize;
            min-width: 80px;
        }

        .confidence-bar {
            flex: 1;
            height: 8px;
            background: #374151;
            border-radius: 4px;
            margin: 0 15px;
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #10B981 0%, #06B6D4 100%);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .confidence-value {
            font-size: 0.9rem;
            color: #D1D5DB;
            min-width: 40px;
            text-align: right;
        }

        .advice-panel {
            grid-column: span 2;
            margin-top: 20px;
        }

        .advice-content {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid #10B981;
            border-radius: 12px;
            padding: 25px;
        }

        .advice-text {
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .advice-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: #D1D5DB;
        }

        .advice-type {
            background: #10B981;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 600;
        }

        .hidden {
            display: none !important;
        }

        .error-message {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid #EF4444;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            color: #FCA5A5;
        }

        .audio-visualizer {
            width: 100%;
            height: 120px;
            background: #000;
            border: 1px solid #10B981;
            border-radius: 8px;
            margin: 15px 0;
        }

        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .advice-panel {
                grid-column: span 1;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ ASTRONAUT EMOTION DETECTION SYSTEM</h1>
            <div class="status-bar">
                <div class="status-item">
                    <div class="status-dot" id="cameraStatusDot"></div>
                    <span id="cameraStatusText">Camera: Requesting...</span>
                </div>
                <div class="status-item">
                    <div class="status-dot" id="audioStatusDot"></div>
                    <span id="audioStatusText">Audio: Requesting...</span>
                </div>
                <div class="status-item">
                    <div class="status-dot" id="detectionStatusDot"></div>
                    <span id="detectionStatusText">Detection: Off</span>
                </div>
            </div>
        </div>

        <div class="main-grid">
            <!-- Video Panel -->
            <div class="panel">
                <h2>üìπ Live Video Monitoring</h2>
                <div class="video-container">
                    <video id="videoElement" autoplay muted playsinline></video>
                    <canvas id="overlayCanvas"></canvas>
                    <div class="placeholder" id="videoPlaceholder">
                        <div class="placeholder-content">
                            <h3>üé• Camera Access Required</h3>
                            <p>Click "Start Camera" to begin emotion detection</p>
                        </div>
                    </div>
                </div>
                
                <div style="text-align: center;">
                    <button class="btn" id="startCameraBtn">Start Camera</button>
                    <button class="btn" id="stopCameraBtn" disabled>Stop Camera</button>
                </div>

                <div class="emotion-bars" id="emotionBars">
                    <p style="text-align: center; color: #9CA3AF;">No emotions detected yet</p>
                </div>
            </div>

            <!-- Audio Panel -->
            <div class="panel">
                <h2>üé§ 15-Second Audio Analysis</h2>
                <button class="btn btn-record" id="recordBtn">üéôÔ∏è Start 15-Second Recording</button>
                
                <div class="countdown" id="countdown">15</div>
                
                <canvas class="audio-visualizer" id="audioCanvas" width="400" height="120"></canvas>
                
                <div id="audioResults" style="margin-top: 15px;">
                    <p style="text-align: center; color: #9CA3AF;">Click record to analyze voice emotions</p>
                </div>
            </div>
        </div>

        <!-- Advice Panel -->
        <div class="panel advice-panel">
            <h2>ü§ñ AI Emotional Support</h2>
            <div class="advice-content">
                <div class="advice-text" id="adviceText">
                    Welcome to the Astronaut Emotion Support System. This system will monitor your emotional state and provide personalized AI guidance for your mission. Click "Start Camera" to begin real-time monitoring.
                </div>
                <div class="advice-meta">
                    <span class="advice-type" id="adviceType">Welcome Message</span>
                    <span id="confidenceLevel">System Ready</span>
                </div>
            </div>
            <div style="text-align: center; margin-top: 15px;">
                <button class="btn" id="speakBtn">üîä Speak Advice</button>
                <button class="btn" id="generateAdviceBtn">üí° Get New Advice</button>
            </div>
        </div>
    </div>

    <script>
        class LocalEmotionSystem {
            constructor() {
                this.videoStream = null;
                this.audioStream = null;
                this.mediaRecorder = null;
                this.audioChunks = [];
                this.isRecording = false;
                this.isDetecting = false;
                this.recordingTimer = null;
                this.detectionInterval = null;
                this.countdownValue = 15;
                
                // Audio visualization
                this.audioContext = null;
                this.analyser = null;
                this.dataArray = null;
                
                // Current emotions
                this.currentEmotions = {};
                this.dominantEmotion = 'neutral';
                
                this.init();
            }

            async init() {
                console.log('üöÄ Initializing Local Emotion System...');
                this.setupEventListeners();
                await this.requestPermissions();
            }

            setupEventListeners() {
                document.getElementById('startCameraBtn').addEventListener('click', () => this.startCamera());
                document.getElementById('stopCameraBtn').addEventListener('click', () => this.stopCamera());
                document.getElementById('recordBtn').addEventListener('click', () => this.toggleRecording());
                document.getElementById('speakBtn').addEventListener('click', () => this.speakAdvice());
                document.getElementById('generateAdviceBtn').addEventListener('click', () => this.generateAdvice());
            }

            async requestPermissions() {
                try {
                    // Request both permissions
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: true, 
                        audio: true 
                    });
                    
                    // Stop the stream (we'll create new ones when needed)
                    stream.getTracks().forEach(track => track.stop());
                    
                    this.updateStatus('camera', 'granted', 'Camera: Ready');
                    this.updateStatus('audio', 'granted', 'Audio: Ready');
                    
                    console.log('‚úÖ Permissions granted');
                    
                } catch (error) {
                    console.error('‚ùå Permission denied:', error);
                    this.showError('Camera/Microphone access denied. Please allow access and refresh.');
                    this.updateStatus('camera', 'error', 'Camera: Denied');
                    this.updateStatus('audio', 'error', 'Audio: Denied');
                }
            }

            async startCamera() {
                try {
                    console.log('üìπ Starting camera...');
                    
                    this.videoStream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            width: { ideal: 1280 },
                            height: { ideal: 720 },
                            facingMode: 'user'
                        }
                    });

                    const video = document.getElementById('videoElement');
                    video.srcObject = this.videoStream;
                    
                    video.onloadedmetadata = () => {
                        video.play();
                        this.setupCanvas();
                        this.startDetection();
                    };

                    document.getElementById('videoPlaceholder').classList.add('hidden');
                    document.getElementById('startCameraBtn').disabled = true;
                    document.getElementById('stopCameraBtn').disabled = false;
                    
                    this.updateStatus('camera', 'active', 'Camera: Active');
                    
                    console.log('‚úÖ Camera started');
                    
                } catch (error) {
                    console.error('‚ùå Camera failed:', error);
                    this.showError('Failed to start camera: ' + error.message);
                }
            }

            stopCamera() {
                if (this.videoStream) {
                    this.videoStream.getTracks().forEach(track => track.stop());
                    this.videoStream = null;
                }
                
                this.stopDetection();
                
                document.getElementById('videoElement').srcObject = null;
                document.getElementById('videoPlaceholder').classList.remove('hidden');
                document.getElementById('startCameraBtn').disabled = false;
                document.getElementById('stopCameraBtn').disabled = true;
                
                this.updateStatus('camera', 'inactive', 'Camera: Off');
                
                console.log('üõë Camera stopped');
            }

            setupCanvas() {
                const video = document.getElementById('videoElement');
                const canvas = document.getElementById('overlayCanvas');
                
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
            }

            startDetection() {
                this.isDetecting = true;
                this.updateStatus('detection', 'active', 'Detection: Active');
                
                this.detectionInterval = setInterval(() => {
                    this.detectEmotions();
                }, 2000);
                
                console.log('üîç Detection started');
            }

            stopDetection() {
                this.isDetecting = false;
                this.updateStatus('detection', 'inactive', 'Detection: Off');
                
                if (this.detectionInterval) {
                    clearInterval(this.detectionInterval);
                    this.detectionInterval = null;
                }
            }

            detectEmotions() {
                // Simulate realistic emotion detection
                const emotions = ['neutral', 'happy', 'sad', 'angry', 'fearful', 'disgusted', 'surprised'];
                const newEmotions = {};
                
                emotions.forEach(emotion => {
                    newEmotions[emotion] = Math.random() * 100;
                });
                
                // Make one emotion dominant
                const dominantIndex = Math.floor(Math.random() * emotions.length);
                newEmotions[emotions[dominantIndex]] = Math.random() * 40 + 60;
                
                this.currentEmotions = newEmotions;
                this.dominantEmotion = emotions[dominantIndex];
                
                this.updateEmotionDisplay();
                this.drawOverlay();
                this.generateAdvice();
            }

            updateEmotionDisplay() {
                const container = document.getElementById('emotionBars');
                const sortedEmotions = Object.entries(this.currentEmotions)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 5);
                
                container.innerHTML = '';
                
                sortedEmotions.forEach(([emotion, confidence]) => {
                    const bar = document.createElement('div');
                    bar.className = 'emotion-bar';
                    bar.innerHTML = `
                        <span class="emotion-name">${emotion}</span>
                        <div class="confidence-bar">
                            <div class="confidence-fill" style="width: ${confidence}%"></div>
                        </div>
                        <span class="confidence-value">${Math.round(confidence)}%</span>
                    `;
                    container.appendChild(bar);
                });
            }

            drawOverlay() {
                const canvas = document.getElementById('overlayCanvas');
                const ctx = canvas.getContext('2d');
                
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Draw face detection box
                const centerX = canvas.width / 2;
                const centerY = canvas.height / 2;
                const boxWidth = 200;
                const boxHeight = 240;
                
                ctx.strokeStyle = '#10B981';
                ctx.lineWidth = 3;
                ctx.strokeRect(centerX - boxWidth/2, centerY - boxHeight/2, boxWidth, boxHeight);
                
                // Draw emotion label
                ctx.fillStyle = '#10B981';
                ctx.font = '16px Arial';
                const confidence = Math.round(this.currentEmotions[this.dominantEmotion] || 0);
                ctx.fillText(`${this.dominantEmotion} (${confidence}%)`, 
                           centerX - boxWidth/2, centerY - boxHeight/2 - 10);
            }

            async toggleRecording() {
                if (this.isRecording) {
                    this.stopRecording();
                } else {
                    await this.startRecording();
                }
            }

            async startRecording() {
                try {
                    console.log('üé§ Starting recording...');
                    
                    this.audioStream = await navigator.mediaDevices.getUserMedia({
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true
                        }
                    });

                    this.setupAudioVisualization();
                    
                    this.mediaRecorder = new MediaRecorder(this.audioStream);
                    this.audioChunks = [];
                    
                    this.mediaRecorder.ondataavailable = (event) => {
                        this.audioChunks.push(event.data);
                    };
                    
                    this.mediaRecorder.onstop = () => {
                        this.processRecording();
                    };
                    
                    this.mediaRecorder.start();
                    this.isRecording = true;
                    this.startCountdown();
                    
                    const recordBtn = document.getElementById('recordBtn');
                    recordBtn.textContent = 'üõë Stop Recording';
                    recordBtn.classList.add('recording');
                    
                    this.updateStatus('audio', 'active', 'Audio: Recording');
                    
                } catch (error) {
                    console.error('‚ùå Recording failed:', error);
                    this.showError('Failed to start recording: ' + error.message);
                }
            }

            stopRecording() {
                if (this.mediaRecorder) {
                    this.mediaRecorder.stop();
                }
                
                if (this.audioStream) {
                    this.audioStream.getTracks().forEach(track => track.stop());
                    this.audioStream = null;
                }
                
                this.isRecording = false;
                
                if (this.recordingTimer) {
                    clearInterval(this.recordingTimer);
                    this.recordingTimer = null;
                }
                
                const recordBtn = document.getElementById('recordBtn');
                recordBtn.textContent = 'üéôÔ∏è Start 15-Second Recording';
                recordBtn.classList.remove('recording');
                
                document.getElementById('countdown').textContent = '15';
                
                this.updateStatus('audio', 'inactive', 'Audio: Ready');
            }

            setupAudioVisualization() {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const source = this.audioContext.createMediaStreamSource(this.audioStream);
                    this.analyser = this.audioContext.createAnalyser();
                    this.analyser.fftSize = 256;
                    
                    source.connect(this.analyser);
                    
                    const bufferLength = this.analyser.frequencyBinCount;
                    this.dataArray = new Uint8Array(bufferLength);
                    
                    this.drawAudioVisualization();
                } catch (error) {
                    console.error('Audio visualization failed:', error);
                }
            }

            drawAudioVisualization() {
                if (!this.analyser || !this.isRecording) return;
                
                const canvas = document.getElementById('audioCanvas');
                const ctx = canvas.getContext('2d');
                
                this.analyser.getByteFrequencyData(this.dataArray);
                
                ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                const barWidth = (canvas.width / this.dataArray.length) * 2.5;
                let x = 0;
                
                for (let i = 0; i < this.dataArray.length; i++) {
                    const barHeight = (this.dataArray[i] / 255) * canvas.height;
                    
                    ctx.fillStyle = `rgb(16, ${barHeight + 100}, 129)`;
                    ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
                    
                    x += barWidth + 1;
                }
                
                if (this.isRecording) {
                    requestAnimationFrame(() => this.drawAudioVisualization());
                }
            }

            startCountdown() {
                this.countdownValue = 15;
                
                this.recordingTimer = setInterval(() => {
                    this.countdownValue--;
                    document.getElementById('countdown').textContent = this.countdownValue;
                    
                    if (this.countdownValue <= 0) {
                        this.stopRecording();
                    }
                }, 1000);
            }

            processRecording() {
                const audioBlob = new Blob(this.audioChunks, { type: 'audio/wav' });
                
                // Simulate audio emotion analysis
                const audioEmotions = ['happy', 'sad', 'angry', 'fearful', 'neutral', 'excited'];
                const detectedEmotion = audioEmotions[Math.floor(Math.random() * audioEmotions.length)];
                const confidence = Math.round(Math.random() * 40 + 60);
                
                document.getElementById('audioResults').innerHTML = `
                    <h4 style="color: #10B981;">Audio Analysis Complete</h4>
                    <p>Voice Emotion: <strong>${detectedEmotion}</strong> (${confidence}%)</p>
                    <p>Duration: 15 seconds</p>
                `;
                
                this.generateAdvice(detectedEmotion);
            }

            generateAdvice(audioEmotion = null) {
                const emotion = audioEmotion || this.dominantEmotion || 'neutral';
                
                const adviceDatabase = {
                    neutral: "Excellent emotional stability! You're maintaining optimal focus for mission operations.",
                    happy: "Outstanding positive energy! This emotional state enhances team collaboration and complex task performance.",
                    sad: "I detect some melancholy. This is normal during long missions. Consider connecting with Earth or practicing mindfulness.",
                    angry: "Frustration detected. Take a break from current tasks and engage in breathing exercises or light physical activity.",
                    fearful: "Anxiety present. Remember your extensive training and use grounding techniques to maintain emotional balance.",
                    disgusted: "Discomfort noted. Identify the source and address it within mission parameters. Don't let irritations accumulate.",
                    surprised: "Unexpected reaction detected. Take time to assess the situation methodically using your training protocols."
                };
                
                const advice = adviceDatabase[emotion] || adviceDatabase.neutral;
                const confidence = this.currentEmotions[emotion] ? Math.round(this.currentEmotions[emotion]) : 75;
                
                document.getElementById('adviceText').textContent = advice;
                document.getElementById('adviceType').textContent = audioEmotion ? 'Audio + Video Analysis' : 'Video Analysis';
                document.getElementById('confidenceLevel').textContent = `${confidence}% Confidence`;
            }

            speakAdvice() {
                const text = document.getElementById('adviceText').textContent;
                if ('speechSynthesis' in window && text) {
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.rate = 0.8;
                    utterance.pitch = 1;
                    speechSynthesis.speak(utterance);
                }
            }

            updateStatus(type, status, text) {
                const dot = document.getElementById(`${type}StatusDot`);
                const textEl = document.getElementById(`${type}StatusText`);
                
                dot.className = 'status-dot';
                if (status === 'active' || status === 'granted') {
                    dot.classList.add('active');
                } else if (status === 'error') {
                    dot.classList.add('error');
                }
                
                textEl.textContent = text;
            }

            showError(message) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                errorDiv.textContent = message;
                
                document.querySelector('.container').insertBefore(errorDiv, document.querySelector('.main-grid'));
                
                setTimeout(() => {
                    errorDiv.remove();
                }, 10000);
            }
        }

        // Initialize when page loads
        window.addEventListener('DOMContentLoaded', () => {
            new LocalEmotionSystem();
        });
    </script>
</body>
</html>